<html>
<head>
  <title>Cinco Analysis Generator</title>
    <link rel="stylesheet" type="text/css" href="resources/resources/css/ext-all.css" />
    <link rel="stylesheet" type="text/css" href="highlighter.css" />
    
    <style type="text/css">
    html, body {
        font:normal 12px verdana;
        margin:0;
        padding:0;
        border:0 none;
        overflow:hidden;
        height:100%;
    }
    p {
        margin:5px;
    }
    pf_icon {
        background-image:url(images/binary.png);
    }
    data_object {
        background-image:url(images/kivio_flw.png);
    }
    graph { 
        background-image:url(images/graph.png) !important; //add images to tabs
    }
    console { 
        background-image:url(images/console.png) !important;
    }
    #input_line {
        font-family: monospace;
    }
    #cell_output {
        font-family: monospace;
    }
    td.code {
        padding-left: 20px;
        font-family: monospace;
    }
    div#status-region div.x-grid3-cell-inner {
        font-family: monospace;
        font-size: 120%;
    }
    </style>

    <!-- LIBS -->
    <script type="text/javascript" src="resources/adapter/ext/ext-base.js"></script>
    <script type="text/javascript" src="resources/ext-all.js"></script>

    <!-- INTERACTIVE -->
    <script type="text/javascript" src="resources/ext-repl-api.js"></script>
    <script type="text/javascript" src="resources/ext-pflist-api.js"></script>

    <!-- LOCAL FUNCTIONS -->
    <script type="text/javascript" src="js/functions.js"></script>

    <script type="text/javascript">
    var viewport;
    function cell_sent() {
        repl_input.get('input_line').setReadOnly(true);
    }
    var examine;
    var number_log_records = 0;
    var number_images = 0;
    function display_image(image_id) {
        var image = Ext.get(image_id);
        var src = image.dom.src;
        var virtualdom = '<html><title>Image Viewer</title><body><img src="' + src + '"/></body></html>',
            prev       = window.open('', 'image_viewer');
        prev.document.open();
        prev.document.write(virtualdom);
        prev.document.close();
    }

    function cell_finished(result, new_cell) {
        Ext.each(result['payloads'], function(payload, index) {
            if (payload['type'] == 'png_string') {
                new_cell.add(new Ext.Panel({
                                autoEl:{
                                tag:'img', width:'25%',
                                src:"data:image/png;base64," +
                                        payload['image_data'],
                                id:"payload_image_" + number_images,
                                onClick: "display_image('payload_image_" +
                                          number_images + "');"
                              }}));
                new_cell.doLayout();
                number_images++;
            } else if (payload['type'] == 'cell_contents') {
                var input_line = repl_input.get("input_line")
                input_line.setValue(payload['value']);
            } else if (payload['type'] == 'log_entry') {
                var record = new logging_store.recordType(
                                {record: payload['log_entry'] });
                logging_store.add(record, number_log_records++);
            }
        });
        repl_input.get('input_line').setReadOnly(false);
        yt_rpc.ExtDirectParameterFileList.get_list_of_pfs({}, fill_tree);
    }

    var res;
    var cell_count = 0;

    var handle_result = function(f, a) {
        var input_line = repl_input.get("input_line")
        cell_count += 1;
        if (a.result == null) {
            text = "ERROR";
            formatted_input = input_line.getValue();
        } else {
            //text = a.result['output'].replace(/\n/g,"<br/>");
            text = "<pre>"+a.result['output']+"</pre>";
            formatted_input = a.result['input']
        }
        var cell = NewCell("cell_"+cell_count, formatted_input, text);
        notebook.get("output_container").add(cell);
        notebook.doLayout();
        input_line.setValue("");
        res = cell;
        cell_finished(a.result, cell);
    }

    var repl_input = new Ext.FormPanel({
        title: 'YT Input',
        url: 'push',
        flex: 0.2,
        layout: 'fit',
        items: [{
            id: 'input_line',
            xtype: 'textarea',
            width: '100%',
            autoScroll: true,
            name: 'line',
            allowBlank: 'True',
            bodyStyle: 'font-family: "monospace";',
            listeners: {
                specialkey: function(f, e){
                    if (e.getKey() == e.ENTER) {
                        cell_sent();
                        yt_rpc.ExtDirectREPL.execute({
                            code:repl_input.get('input_line').getValue()},
                            handle_result);
                    }
                }
            },
        },],
    });

    var NorthButton = new Ext.Button(
        {text : 'North',
        pageX : 205,
        pageY : 10
//        handler: function(b, e) { window.open("session.py", "_top"); }
        }
    );

    var EastButton = new Ext.Button(
        {text:'East',
        pageX : 410,
        pageY : 205
        }
    );
    var SouthButton = new Ext.Button(
        {text:'South',
        pageX : 205,
        pageY : 410
        }
    );
    var WestButton = new Ext.Button(
        {text:'West',
        pageX : 10,
        pageY : 205
        }
    );

    function NewCell(name, input, result) {
        var CellPanel = new Ext.Panel(
            {id: name,
             items: [new Ext.Panel({
                        id:name+"_input",
                        html:input,
                        }),
                     new Ext.Panel({
                        id:name+"_result",
                        html:result,
                        })
                    ]
            }
        );
        return CellPanel;
    }

    var OutputContainer = new Ext.Panel({
          title: 'YT Output',
          id: 'output_container',
          autoScroll: true,
          flex: 0.8,
          items: []
        });

    var PlotPanel = new Ext.Panel(
        {
        title: 'Plot Window 1',
        iconCls: 'graph',
        autoScroll: true,
        layout:'absolute',
        items: [ 
            NorthButton,
            EastButton,
            SouthButton,
            WestButton
        ]
    });
    var examine;
    var notebook;
    var treePanel = new Ext.tree.TreePanel({
        iconCls: 'nav',
    	id: 'tree-panel',
    	title: 'Objects',
        layout: 'anchor',
        region:'west',
        split: true,
        anchor: '100% -35',
        minSize: 150,
        autoScroll: true,
        rootVisible: false,
        root:new Ext.tree.TreeNode({
          expanded:true
         ,leaf:false
         ,text:''
        })
     });

    var ButtonGroupPanel = new Ext.Panel({
        layout: 'anchor',
        ButtonAlign: 'center',
        collapsible: false,
        renderTo: document.body,
        tbar: [{
            xtype: 'buttongroup',
            columns: 3,
            items: [{
                text: 'Download',
                layout:'anchor',
                anchor: '100% 33%',
                handler: function(b, e) { window.open("session.py", "_top"); }
            },{
                text: 'Save',
                layout:'anchor',
                anchor: '100% 67%',
            },{
                text: 'Pastebin',
                layout:'anchor',
                anchor: '100% 100%',
            }]
        }]
    });
    
    var status_panel;
    var logging_store = new Ext.data.Store({
            fields: [{name:'record'}],
            reader: new Ext.data.ArrayReader({}, [{name: 'record'}]),
            });

    Ext.onReady(function(){

Ext.BLANK_IMAGE_URL = 'resources/resources/images/default/s.gif';

        // NOTE: This is an example showing simple state management. During development,
        // it is generally best to disable state management as dynamically-generated ids
        // can change across page loads, leading to unpredictable results.  The developer
        // should ensure that stable state ids are set for stateful components in real apps.
        Ext.state.Manager.setProvider(new Ext.state.CookieProvider());

	// Go ahead and create the TreePanel now so that we can use it below
        viewport = new Ext.Viewport({
            layout: 'border',
            items: [
            {
                // lazily created panel (xtype:'panel' is default)
                xtype: 'grid',
                store: logging_store,
                columns: [ {id:'record', 
                            sortable: false,
                            width:800} ],
                autofill: true,
                region: 'south',
                id: "status-region",
                cls: "status-logger",
                split: true,
                height: 100,
                maxSize: 200,
                collapsible: true,
                title: 'Status',
                margins: '0 0 0 0',
            }, {
                region: 'west',
                id: 'west-panel', // see Ext.getCmp() below
                title: 'BETA Sequences',
                split: true,
                width: 200,
                minSize: 175,
                maxSize: 400,
                collapsible: true,
                margins: '0 0 0 5',
                layout: {
                    type: 'anchor',
                },
                items: [
                    treePanel,
                    ButtonGroupPanel
                ]
            },
            // in this instance the TabPanel is not wrapped by another panel
            // since no title is needed, this Panel is added directly
            // as a Container
            {
                xtype: 'tabpanel',
                region: 'center', // a center region is ALWAYS required for border layout
                id: 'center-panel',
                deferredRender: false,
                activeTab: 0,     // first tab initially active
                items: [{
                    title: 'YT',
                    id: 'notebook',
                    layout: 'vbox',
                    layoutConfig: {align:'stretch'},
                    closable: false,
                    autoScroll: false,
                    iconCls: 'console',
                    items: [repl_input, OutputContainer]
                }, PlotPanel]
//                }, {
 //                   title: 'Plot Window 1',
  //                  iconCls: 'graph',
   //                 layout:'anchor',
    //                anchor:'100% 100%',
     //               closable: true,
      //              autoScroll: true,
       //             items: [ PlotPanel ]
        //                
         //       }]
            }]
        });
        // get a reference to the HTML element with id "hideit" and add a click listener to it 
        Ext.get("hideit").on('click', function(){
            // get a reference to the Panel that was created with id = 'west-panel' 
            var w = Ext.getCmp('west-panel');
            // expand or collapse that Panel based on its collapsed property state
            w.collapsed ? w.expand() : w.collapse();
        });
        
        notebook = viewport.get("center-panel").get("notebook");
        status_panel = viewport.get("status-region").get("status-div");

        var record = new logging_store.recordType(
                        {record: '4d3d3d3 engaged' });
        logging_store.add(record, number_log_records++);
    });
    </script>
</head>
<body>
    <!-- use class="x-hide-display" to prevent a brief flicker of the content -->
    <div id="west" class="x-hide-display">
    </div>
    <div id="center2" class="x-hide-display">
        <a id="hideit" href="#">Toggle the west region</a>
    </div>
    <div id="props-panel" class="x-hide-display" style="width:200px;height:200px;overflow:hidden;">
    </div>
    <div id="south" class="x-hide-display">
    </div>
</body>
</html>
